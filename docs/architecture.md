系统架构草案

概览
- 目标：提供可商用的台球厅运营系统，满足实时桌态检测、计时计费、收银结算、支付集成、报表与运维要求。
- 部署：本地优先（on-prem），可选云端备份/多店汇总。

关键组件
1. 台桌检测层
- 主要触发：灯控信号作为占用/释放触发（灯光打开即视为占用，灯光关闭视为释放）。
- 推荐实现：在每张桌子的灯路上接入干接点/继电器状态检测模块（例如 Shelly/ESP32 + 干接点），通过 MQTT/HTTP 上报状态到本地网关。
- 可选冗余：加入压力/红外/视觉模块以降低误报率（后期扩展）。

2. 边缘网关与网络
- 网关设备：Raspberry Pi 4 / Intel NUC 或同类边缘服务器，负责本地聚合、缓存与转发。
- 协议：MQTT（轻量、离线缓存）、或直接 HTTPS + WebSocket；优先使用 MQTT + 后端 WebSocket 转发给前端。
- 网络：独立局域网，PoE 交换机 + 管理型 AP，关键设备上 UPS。

3. 本地后端服务
- 数据库：PostgreSQL（持久化计时、流水、会员、报表）。
- 后端：建议使用 Node.js (Express/Koa) 或 Python (FastAPI)，提供 REST API + WebSocket 实时推送。
- 功能：桌态管理、计费引擎、支付记录、对账、审计日志、导出报表、离线缓存与回补。

4. 前端与 POS
- 收银端：基于浏览器的 PWA（React/Vue），兼容 Android 平板与 Windows 桌面，提供桌位地图、开台/续时/结账、挂单、退款、会员管理。
- 管理后台：权限分级（管理员/收银/经理），实时监控、营业报表、设备状态、操作日志。
- 顾客端：可选小程序或 PWA，用于查看空桌、预约与充值。

5. 支付与对账
- 本地接入：显示或扫描 QR（支持本地银行 QR、TNG、SarawakPay 等），并记录外部回调/交易凭证。
- 离线策略：交易记录先保存在本地，网络可用时向支付网关确认/同步；支持手工对账与导出对账文件。

6. 安全与合规
- 本地网络隔离，后端启用 TLS（内部签发或自签加内网 CA），数据库加密敏感字段（会员信息、支付凭证）。
- 日志与审计：记录所有收费/修改操作的操作者及时间。

数据流（简要）
1. 灯控检测模块检测到灯开，向网关发 MQTT "table/{id}/occupied = true"。
2. 网关收到后调用后端 API：POST /api/tables/{id}/state，后端创建会话并开始计时。
3. 后端通过 WebSocket 推送实时桌态到 POS 前端；前端显示已占用并开始计费计时 UI。
4. 收银操作（续时/结账）通过 REST 接口触发计费引擎，生成订单并返回结算二维码或等待客户付款确认。
5. 支付回调到本地后端并写入流水，触发打印/电子收据并完成订单结算。

离线容错策略
- 灯控模块与网关通过本地网络通信；若网关与后端间断线，网关缓存事件并在恢复后回补。
- 前端在短时断网时继续使用本地缓存并在恢复后同步操作日志。

阶段性交付（短期 MVP）
- 实现灯控触发 + 本地后端最小 API（开始/结束会话）+ 浏览器 POS 的实时桌态显示与手动结账。
- 支付模块先实现“记录现金/扫码已支付”的手动确认流程，后续接入自动回调的支付网关。

下一步：基于此架构我会列出推荐硬件清单与预估价格，便于采购决策。